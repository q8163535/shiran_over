#include <stdio.h>



/*
1、	基本状态标识定义（大写字母）：
    A：绿常亮           B：黄常亮                   C：红1常亮          D：红2常亮                     E：绿闪2次          F：黄闪5次
    G：黄闪3次          H：黄闪2次                  I：黄闪1次          J：红1、绿互闪3次              K：红1、绿互闪3次
    L：黄、绿互闪3次    M：红1闪 (命令故障)         N：无灯             P：命令无效，保持原灯状态      Q: 红1闪(链路故障)
2、	由基本状态的组合构成了包含32个组合状态的状态空间，其中的每一个组合状态有一个编号。

3、	表格中XX(a)-xx(c)-n-YY(b)-yy(d)表示状态转移输出。
    XX(a)表示接受命令转移后的暂态状态，其中(a)为ST_Tab表的内容；
    n表示为输出语音报警的编码（参见表5），是VT_Tab表的内容，该编码和调车命令码相同并扩展了29、30、31号编码（参见表3）；
    YY(b)表示接受命令后的稳态状态，其中(b)为FT_Tab表的内容；
    xx(c)表示暂态执行命令，其中(c)为ES_Tab表的内容；
    yy(d)表示稳态执行命令, 其中(d)为EF_Tab表的内容。

4、状态执行编码定义（小写字母）：
    a(0)：绿常亮；                       !a(1)：绿常亮，其余灯灭；            b(2)：黄常亮；                        !b(3)：黄常亮，其余灯灭；
    c(4)：红1常亮；                      !c(5)：红1常亮，其余灯灭；           d(6)：红2常亮，                       !d(7)：红2常亮，其余灯灭；
    e(8)：绿闪2次                        !e(9)：绿闪2次，其余灯灭；           f(10)：黄闪5次；                      !f(11)：黄闪5次，其余灯灭；
    g(12)：黄闪3次；                     !g(13)：黄闪3次，其余灯灭；          h(14)：黄闪2次；                      !h(15) ：黄闪2次，其余灯灭；
    i(16)：黄闪1次；                     !i(17)：黄闪1次，其余灯灭；          !j(18)：红1、绿互闪3次，其余灯灭；    !k(19)：红1、黄互闪3次，其余灯灭
    !l(20)：黄、绿互闪3次，其余灯灭；    m(21)：红1闪；                       !m(22)：红1闪，其余灯灭；              n(23)：无灯；
    !cd(24)：红1和红2灯亮，其余灯灭；    !md(25)：红1闪并且红2灯亮，其余灯灭；q(26)：进入链路故障停车状态
    x(29)：红1灯灭                       y(30)：红2灯灭                       p(31)：无效命令

*/

//暂态转移表
const unsigned char st_tab[32][32]= {
    { 2, 2, 2,21, 2,22, 2, 2, 2, 2, 2, 2, 2,22, 2, 2, 2,22, 2, 2, 2,21,22,24,24,21,22,24, 2,31,31,31},
    { 0, 0, 0,31, 0,13,14,15,16,31,31,31,28,13,14,15,16,13,14,15,16, 3,13,31,23, 3, 5,23, 0,31,31,31},
    { 4, 4, 4,31, 4,17,18,19,20,31,31,31,28,17,18,19,20,17,18,19,20, 3,17,31,23, 3, 5,23, 4,31,31,31},
    { 1, 1,31,31, 1, 1, 1, 1, 1,31,31,31,31, 1, 1, 1, 1, 1, 1, 1, 1,31,31,31,31,31,31,31, 1,31,31,31},
    {14, 6,31,31,18, 6, 6, 6, 6,31,31,31,31,14,14,14,14,18,18,18,18,31,31,31,31,31,31,31, 6,31,31,31},
    {15, 7,31,31,19, 7, 7, 7, 7,31,31,31,31,15,15,15,15,19,19,19,19,31,31,31,31,31,31,31, 7,31,31,31},
    {16, 8,31,31,20, 8, 8, 8, 8,31,31,31,31,16,16,16,16,20,20,20,20,31,31,31,31,31,31,31, 8,31,31,31},
    {16, 8,31,31,20, 8, 8, 8, 8,31,31,31,31,16,16,16,16,20,20,20,20,31,31,31,31,31,31,31, 8,31,31,31},
    { 9, 9, 9,31, 9, 9, 9, 9, 9,31,31,31,31, 9, 9, 9, 9, 9, 9, 9, 9,31, 9,31,31,31,31,31, 9,31,31,31},
    {10,10,10,31,10,10,10,10,10,31,31,31,31,10,10,10,10,10,10,10,10,31,10,31,31,31,31,31,10,31,31,31},
    {11,11,11,31,11,11,11,11,11,31,31,31,31,11,11,11,11,11,11,11,11,31,11,31,31,31,31,31,11,31,31,31},
    {13, 5,22,23,17, 5, 5, 5, 5,31,31,31,26,13,13,13,13,17,17,17,17,24,22,23,24,27,26,27, 5,31,31,31},
    {12,12,31,31,12,26,12,12,12,12,12,12,12,26,12,12,12,26,12,12,12,31,31,31,31,25,26,27,12,12,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,28,31,31,31,31,31,31,31,31,31,31,31,31, 3, 5,23,31,31,31,31},
    { 3, 3,21, 3, 3,23, 3, 3, 3, 3, 3, 3,25,23, 3, 3, 3,23, 3, 3, 3,21,24,23,24,25,27,27, 3,31,31,31},
    {31,31,31,28,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31, 2,31, 5,22,12,31,26,31,31,31,31},
    {13, 5,22,23,17, 5, 5, 5, 5,31,31,31,26,13,13,13,13,17,17,17,17,24,22,23,24,27,26,27, 5,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,21,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31, 2,31,31},
    {31,31,31,31, 4,31,31,31,31,31,31,31,31,31,31,31,31,17,18,19,20,31,31,31,31,31,31,31,31,31,31,31},
    {28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,31,31}
};
//暂态执行表
const unsigned char es_tab[32][32]= {
    { 5, 5, 5, 4, 5, 4, 5, 5, 5, 5, 5, 5, 5, 4, 5, 5, 5, 4, 5, 5, 5, 4, 4, 4, 4, 4, 4, 4, 5,31,31,31},  //停车
    { 1, 1, 1,31, 1, 0, 0, 0, 0,31,31,31,23, 0, 0, 0, 0, 0, 0, 0, 0,29, 0,31,29,29,29,29, 1,31,31,31},	//牵引、启动	（1）
    { 9, 9, 9,31, 9, 8, 8, 8, 8,31,31,31,23, 8, 8, 8, 8, 8, 8, 8, 8,29, 8,31,29,29,29,29, 9,31,31,31},	//推进		（2）
    { 3, 3,31,31, 3, 3, 3, 3, 3,31,31,31,31, 3, 3, 3, 3, 3, 3, 3, 3,31,31,31,31,31,31,31, 3,31,31,31},	//减速		（3）
    {12,13,31,31,12,13,13,13,13,31,31,31,31,12,12,12,12,12,12,12,12,31,31,31,31,31,31,31,13,31,31,31},	//十车		（4）
    {14,15,31,31,14,15,15,15,15,31,31,31,31,14,14,14,14,14,14,14,14,31,31,31,31,31,31,31,15,31,31,31},	//五车		（5）
    {16,17,31,31,16,17,17,17,17,31,31,31,31,16,16,16,16,16,16,16,16,31,31,31,31,31,31,31,17,31,31,31},	//三车		（6）
    {16,17,31,31,16,17,17,17,17,31,31,31,31,16,16,16,16,16,16,16,16,31,31,31,31,31,31,31,17,31,31,31},	//一车		（7）
    {18,18,18,31,18,18,18,18,18,31,31,31,31,18,18,18,18,18,18,18,18,31,18,31,31,31,31,31,18,31,31,31},	//连接		（8）
    {19,19,19,31,19,19,19,19,19,31,31,31,31,19,19,19,19,19,19,19,19,31,19,31,31,31,31,31,19,31,31,31},	//稍行		（9）
    {20,20,20,31,20,20,20,20,20,31,31,31,31,20,20,20,20,20,20,20,20,31,20,31,31,31,31,31,20,31,31,31},	//反稍行		（10）
    {10,11,10,10,10,11,11,11,11,31,31,31,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,31,31,31},	//调车员鸣笛	（11）
    {22,22,31,31,22,21,22,22,22,22,22,22,22,21,22,22,22,21,22,22,22,31,31,31,31,21,21,21,22,22,31,31},	//命令故障停车	（12）
    {31,31,31,31,31,31,31,31,31,31,31,31,23,31,31,31,31,31,31,31,31,31,31,31,31,29,29,29,31,31,31,31},	//故障解锁	（13）
    { 7, 7, 6, 7, 7, 6, 7, 7, 7, 7, 7, 7, 6, 6, 7, 7, 7, 6, 7, 7, 7, 6, 6, 6, 6, 6, 6, 6, 7,31,31,31},	//紧急停车	（14）
    {31,31,31,23,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,30,31,30,30,30,31,30,31,31,31,31},	//拆除紧急停车	（15）
    {10,11,10,10,10,11,11,11,11,31,31,31,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,31,31,31},	//连接员鸣笛    	（16）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},	//非法命令	（17）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},	//非法命令	（18）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},	//非法命令	（19）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},	//非法命令	（20）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},	//非法命令	（21）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},	//非法命令	（22）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},	//非法命令	（23）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},	//非法命令	（24）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},	//非法命令	（25）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},	//非法命令	（26）
    {26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,26,31,31},	//链路故障停车	（27）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,24,31,31},	//链路恢复1	（28）
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31, 5,31,31},	//链路恢复2	（29）
    {31,31,31,31, 9,31,31,31,31,31,31,31,31,31,31,31,31, 8, 8, 8, 8,31,31,31,31,31,31,31,31,31,31,31},	//测机命令	（30）
    {23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,31,31}	//链路恢复3	（31）
};
//语音输出表
const unsigned char vt_tab[32][32]= {
    {12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,31,31,31},
    { 1, 1, 1,31, 1, 1, 1, 1, 1,31,31,31,13, 1, 1, 1, 1, 1, 1, 1, 1,29, 1,31,29,13,13,13, 1,31,31,31},
    { 2, 2, 2,31, 2, 2, 2, 2, 2,31,31,31,13, 2, 2, 2, 2, 2, 2, 2, 2,29, 2,31,29,13,13,13, 2,31,31,31},
    { 3, 3,31,31, 3, 3, 3, 3, 3,31,31,31,31, 3, 3, 3, 3, 3, 3, 3, 3,31,31,31,31,31,31,31, 3,31,31,31},
    { 4, 4,31,31, 4, 4, 4, 4, 4,31,31,31,31, 4, 4, 4, 4, 4, 4, 4, 4,31,31,31,31,31,31,31, 4,31,31,31},
    { 5, 5,31,31, 5, 5, 5, 5, 5,31,31,31,31, 5, 5, 5, 5, 5, 5, 5, 5,31,31,31,31,31,31,31, 5,31,31,31},
    { 6, 6,31,31, 6, 6, 6, 6, 6,31,31,31,31, 6, 6, 6, 6, 6, 6, 6, 6,31,31,31,31,31,31,31, 6,31,31,31},
    { 7, 7,31,31, 7, 7, 7, 7, 7,31,31,31,31, 7, 7, 7, 7, 7, 7, 7, 7,31,31,31,31,31,31,31, 7,31,31,31},
    { 8, 8, 8,31, 8, 8, 8, 8, 8,31,31,31,31, 8, 8, 8, 8, 8, 8, 8, 8,31, 8,31,31,31,31,31, 8,31,31,31},
    { 9, 9, 9,31, 9, 9, 9, 9, 9,31,31,31,31, 9, 9, 9, 9, 9, 9, 9, 9,31, 9,31,31,31,31,31, 9,31,31,31},
    {10,10,10,31,10,10,10,10,10,31,31,31,31,10,10,10,10,10,10,10,10,31,10,31,31,31,31,31,10,31,31,31},
    {11,11,11,11,11,11,11,11,11,31,31,31,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,31,31,31},
    { 0, 0,31,31, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,31,31,31,31, 0, 0, 0, 0, 0,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,13,31,31,31,31,31,31,31,31,31,31,31,31,13,13,13,31,31,31,31},
    {14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,31,31,31},
    {31,31,31,15,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,15,31,15,15,15,31,15,31,31,31,31},
    {11,11,11,11,11,11,11,11,11,31,31,31,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,28,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,28,31,31},
    {31,31,31,31, 2,31,31,31,31,31,31,31,31,31,31,31,31, 2, 2, 2, 2,31,31,31,31,31,31,31,31,31,31,31},
    {13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,31,13,31,31}

};

//稳态转移表
const unsigned char ft_tab[32][32]=  {
    { 2, 2, 2,21, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,21, 2,21,21,21, 2,21, 2,29,28,28},
    { 0, 0, 0, 3, 0, 0, 0, 0, 0, 2, 1, 1,28, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 3, 3, 3,28, 3, 0,29,28,28},
    { 4, 4, 4, 3, 4, 4, 4, 4, 4, 2, 1, 1,28, 4, 4, 4, 4, 4, 4, 4, 4, 3, 4, 3, 3, 3,28, 3, 4,29,28,28},
    { 1, 1, 2, 3, 1, 1, 1, 1, 1, 2, 1, 1,12, 1, 1, 1, 1, 1, 1, 1, 1,21, 2, 3,21,25,12,25, 1,29,28,28},
    { 0, 1, 2, 3, 4,28,28,28,28, 2, 1, 1,12, 0, 0, 0, 0, 4, 4, 4, 4,21, 2, 3,21,25,12,25,28,29,28,28},
    { 0, 1, 2, 3, 4,28,28,28,28, 2, 1, 1,12, 0, 0, 0, 0, 4, 4, 4, 4,21, 2, 3,21,25,12,25,28,29,28,28},
    { 0, 1, 2, 3, 4,28,28,28,28, 2, 1, 1,12, 0, 0, 0, 0, 4, 4, 4, 4,21, 2, 3,21,25,12,25,28,29,28,28},
    { 0, 1, 2, 3, 4,28,28,28,28, 2, 1, 1,12, 0, 0, 0, 0, 4, 4, 4, 4,21, 2, 3,21,25,12,25,28,29,28,28},
    { 2, 2, 2, 3, 2, 2, 2, 2, 2, 2, 1, 1,12, 2, 2, 2, 2, 2, 2, 2, 2,21, 2, 3,21,25,12,25, 2,29,28,28},
    { 1, 1, 1, 3, 1, 1, 1, 1, 1, 2, 1, 1,12, 1, 1, 1, 1, 1, 1, 1, 1,21, 1, 3,21,25,12,25, 1,29,28,28},
    { 1, 1, 1, 3, 1, 1, 1, 1, 1, 2, 1, 1,12, 1, 1, 1, 1, 1, 1, 1, 1,21, 1, 3,21,25,12,25, 1,29,28,28},
    { 0, 1, 2, 3, 4,28,28,28,28, 2, 1, 1,12, 0, 0, 0, 0, 4, 4, 4, 4,21, 2, 3,21,25,12,25,28,29,28,28},
    {12,12, 2, 3,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,21, 2, 3,21,25,12,25,12,12,28,28},
    { 0, 1, 2, 3, 4,28,28,28,28, 2, 1, 1,28, 0, 0, 0, 0, 4, 4, 4, 4,21, 2, 3,21, 3,28, 3,28,29,28,28},
    { 3, 3,21, 3, 3, 3, 3, 3, 3, 3, 3, 3,25, 3, 3, 3, 3, 3, 3, 3, 3,21,21, 3,21,25,25,25,03,29,28,28},
    { 0, 1, 2,28, 4,28,28,28,28, 2, 1, 1,12, 0, 0, 0, 0, 4, 4, 4, 4, 2, 2,28, 2,12,12,25,28,29,28,28},
    { 0, 1, 2, 3, 4,28,28,28,28, 2, 1, 1,12, 0, 0, 0, 0, 4, 4, 4, 4,21, 2, 3,21,25,12,25,28,29,28,28},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,29,28,28},
    { 0, 1, 2, 3, 4,28,28,28,28, 2, 1, 1,12, 0, 0, 0, 0, 4, 4, 4, 4,21, 2, 3,21,25,12,25,28,21,28,28},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31, 2,31,31},
    { 0, 1, 2, 3, 4,28,28,28,28, 2, 1, 1,12, 0, 0, 0, 0, 4, 4, 4, 4,21, 2, 3,21,25,12,25,28,29,28,28},
    {28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28,28}
};

//稳态执行表
const unsigned char ef_tab[32][32]=   {
    { 5, 5, 5,24, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,24, 5,24,24,24,24,24, 5,22,23,23},
    { 1, 1, 1, 7, 1, 1, 1, 1, 1, 5, 3, 3,23, 1, 1, 1, 1, 1, 1, 1, 1, 7, 1, 7, 7, 7,23, 7, 1,22,23,23},
    {23,23,23, 7,23,23,23,23,23, 5, 3, 3,23,23,23,23,23,23,23,23,23, 7,23, 7, 7, 7,23, 7,23,22,23,23},
    { 3, 3, 5, 7, 3, 3, 3, 3, 3, 5, 3, 3,22, 3, 3, 3, 3, 3, 3, 3, 3,24, 5, 7,24,25,22,25, 3,22,23,23},
    { 1, 3, 5, 7,23,23,23,23,23, 5, 3, 3,22, 1, 1, 1, 1,23,23,23,23,24, 5, 7,24,25,22,25,23,22,23,23},
    { 1, 3, 5, 7,23,23,23,23,23, 5, 3, 3,22, 1, 1, 1, 1,23,23,23,23,24, 5, 7,24,25,22,25,23,22,23,23},
    { 1, 3, 5, 7,23,23,23,23,23, 5, 3, 3,22, 1, 1, 1, 1,23,23,23,23,24, 5, 7,24,25,22,25,23,22,23,23},
    { 1, 3, 5, 7,23,23,23,23,23, 5, 3, 3,22, 1, 1, 1, 1,23,23,23,23,24, 5, 7,24,25,22,25,23,22,23,23},
    { 5, 5, 5, 7, 5, 5, 5, 5, 5, 5, 3, 3,22, 5, 5, 5, 5, 5, 5, 5, 5,24, 5, 7,24,25,22,25, 5,22,23,23},
    { 3, 3, 3, 7, 3, 3, 3, 3, 3, 5, 3, 3,22, 3, 3, 3, 3, 3, 3, 3, 3,24, 3, 7,24,25,22,25, 3,22,23,23},
    { 3, 3, 3, 7, 3, 3, 3, 3, 3, 5, 3, 3,22, 3, 3, 3, 3, 3, 3, 3, 3,24, 3, 7,24,25,22,25, 3,22,23,23},
    { 1, 3, 5, 7,23,23,23,23,23, 5, 3, 3,22, 1, 1, 1, 1,23,23,23,23,24, 5, 7,24,25,22,25,23,22,23,23},
    {22,22, 5, 7,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,24, 5, 7,24,25,22,25,22,22,23,23},
    { 1, 3, 5, 7,23,23,23,23,23, 5, 3, 3,23, 1, 1, 1, 1,23,23,23,23,24, 5, 7,24, 7,23, 7,23,22,23,23},
    { 7, 7,24, 7, 7, 7, 7, 7, 7, 7, 7, 7,25, 7, 7, 7, 7, 7, 7, 7, 7,24,24, 7,24,25,25,25, 7,22,23,23},
    { 1, 3, 5,23,23,23,23,23,23, 5, 3, 3,22, 1, 1, 1, 1,23,23,23,23, 5, 5,23, 5,22,22,22,23,22,23,23},
    { 1, 3, 5, 7,23,23,23,23,23, 5, 3, 3,22, 1, 1, 1, 1,23,23,23,23,24, 5, 7,24,25,22,25,23,22,23,23},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,23,23},
    { 1, 3, 5, 7,23,23,23,23,23, 5, 3, 3,22, 1, 1, 1, 1,23,23,23,23,24, 5, 7,24,25,22,25,23,24,23,23},
    {31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31,31, 5,31,31},
    { 1, 3, 5, 7,23,23,23,23,23, 5, 3, 3,22, 1, 1, 1, 1,23,23,23,23,24, 5, 7,24,25,22,25,23,22,23,23},
    {23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23}
};

//平面调车应答命令表
const unsigned char rp_tab[32][32]= {
    { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,99,99,99},
    { 1, 1, 1,99, 1, 1, 1, 1, 1,99,99,99,13, 1, 1, 1, 1, 1, 1, 1, 1,99, 1,99,99,13,13,13, 1,99,99,99},
    { 2, 2, 2,99, 2, 2, 2, 2, 2,99,99,99,13, 2, 2, 2, 2, 2, 2, 2, 2,99, 2,99,99,13,13,13, 2,99,99,99},
    { 3, 3,99,99, 3, 3, 3, 3, 3,99,99,99,99, 3, 3, 3, 3, 3, 3, 3, 3,99,99,99,99,99,99,99, 3,99,99,99},
    { 4, 4,99,99, 4, 4, 4, 4, 4,99,99,99,99, 4, 4, 4, 4, 4, 4, 4, 4,99,99,99,99,99,99,99, 4,99,99,99},
    { 5, 5,99,99, 5, 5, 5, 5, 5,99,99,99,99, 5, 5, 5, 5, 5, 5, 5, 5,99,99,99,99,99,99,99, 5,99,99,99},
    { 6, 6,99,99, 6, 6, 6, 6, 6,99,99,99,99, 6, 6, 6, 6, 6, 6, 6, 6,99,99,99,99,99,99,99, 6,99,99,99},
    { 7, 7,99,99, 7, 7, 7, 7, 7,99,99,99,99, 7, 7, 7, 7, 7, 7, 7, 7,99,99,99,99,99,99,99, 7,99,99,99},
    { 8, 8, 8,99, 8, 8, 8, 8, 8,99,99,99,99, 8, 8, 8, 8, 8, 8, 8, 8,99, 8,99,99,99,99,99, 8,99,99,99},
    { 9, 9, 9,99, 9, 9, 9, 9, 9,99,99,99,99, 9, 9, 9, 9, 9, 9, 9, 9,99, 9,99,99,99,99,99, 9,99,99,99},
    {10,10,10,99,10,10,10,10,10,99,99,99,99,10,10,10,10,10,10,10,10,99,10,99,99,99,99,99,10,99,99,99},
    {11,11,11,11,11,11,11,11,11,99,99,99,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,99,99,99},
    {12,12,99,99,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,99,99,99,99,12,12,12,12,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,13,99,99,99,99,99,99,99,99,99,99,99,99,13,13,13,99,99,99,99},
    {14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,14,99,99,99},
    {99,99,99,15,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,15,99,15,15,15,99,15,99,99,99,99},
    {16,16,16,16,16,16,16,16,16,99,99,99,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,16,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99, 0,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99, 0,99,99},
    {99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99},
    {13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,99,13,99,99},
};




/*
StLampCtrl LampCtrlStr[4]=  {
                                //{5,0,1,CTRLPERD/2+1},
                                //{5,0,1,CTRLPERD/2+1},
                                //{5,0,1,CTRLPERD/2+1},
                                //{5,0,1,CTRLPERD/2+1},
                            }; //CTRLPERD
*/

StLampCtrl LampCtrlStr[4]=  {
    {1,0,0,1},
    {1,0,0,1},
    {1,0,1,CTRLPERD+1},
    {1,0,0,1},
};


//LampActionlType 灯动作类型
#define     LAMPOFF1                0
#define     LAMPON1                 1
#define     LAMPFLASH1              2
#define     LAMPFLASH2              3
#define     LAMPFLASH3              4
#define     LAMPFLASH5              5
#define     LAMPFLASH3REVERSE       6
#define     LAMPFLASHALWAYS         7

const StLampCtrl StLampCtrlArg[]=   {
    {1,     0,  0,              1           },           //灯灭(一个周期)      LAMPOFF1
    {1,     0,  1,              CTRLPERD+1  },           //灯亮(一个周期)      LAMPON1
    {1,     0,  1,              CTRLPERD/2+1},           //灯闪1次(亮 灭)      LAMPFLASH1
    {2,     0,  1,              CTRLPERD/2+1},           //灯闪2次(亮 灭)      LAMPFLASH2
    {3,     0,  1,              CTRLPERD/2+1},           //灯闪3次(亮 灭)      LAMPFLASH3
    {5,     0,  1,              CTRLPERD/2+1},           //灯闪5次(亮 灭)      LAMPFLASH5
    {3,     0,  CTRLPERD/2+1,   CTRLPERD    },           //灯闪3次(灭 亮)      LAMPFLASH3REVERSE
    {0xff,  0,  1,              CTRLPERD/2+1}            //灯闪(无限循环)      LAMPFLASHALWAYS

};

/****************************************************************************
* 名称:         void assignStLampCtrl(StLampCtrl *dst,const StLampCtrl *src)
* 输入参数:     StLampCtrl *dst             目的结构体指针
*               const StLampCtrl *src       源结构体指针
* 输出参数：    void
* 功能:         完成结构体数据的拷贝
****************************************************************************/
void assignStLampCtrl(StLampCtrl *dst,const StLampCtrl *src)
{
    dst->CycNumb=src->CycNumb;
    dst->CtrlTimer=src->CtrlTimer;
    dst->OnTime=src->OnTime;
    dst->OffTimer=src->OffTimer;
}

/****************************************************************************
* 名称:         void AllLampOff(void)
* 输入参数:     void
* 输出参数：    void
* 功能:         将调车灯全部关闭
****************************************************************************/
void AllLampOff(void)
{
    unsigned char i;
    for (i=greenlamp;i<=redlamp2;i++)
    {
        assignStLampCtrl(&LampCtrlStr[i],&StLampCtrlArg[LAMPOFF1]);
    }
}



//int taskflag =  false;

extern unsigned char cRecvExPfix ;
extern unsigned short GroupID ;
extern unsigned char PlaneShuntingModeCodeValue;




char endebugNUM = 0;

extern void RecvMessDisplayProc(BYTE nStatus,unsigned short nSendID) ;
extern int OnRailShunt(WPARAM style,LPARAM nOper);
/*********************************************************************************************************
**                            Task2 任务2
**功能描述：建立灯显及语音的数据结构，并进行语音播放
********************************************************************************************************/
void  Task2(void *pdata)
{

    Map27_MobileID g_ID;
    g_ID.pfix = cRecvPfix;
    g_ID.ident = nRecvID;
    pdata = pdata;                                      /* 避免编译警告 */
    unsigned char err;
    unsigned char *PPlaneShuntingModeCode;
    unsigned char ResponseCmd;
    unsigned char ReturnCmd;

    unsigned char status;
    unsigned char sendID;

    //add shiran initqueue
    initqueue();

    if (psPSModeCodeF->PSModeCodeValid==TRUE)				//如果记录调车码的flash是有效的（不是未被烧写过的）
    {
        if ( ( ( (psPSModeCodeF->PSModeCode) >>5) & 0x03) !=0 )	//且存有紧急停车命令
        {
            //OSMboxPost(PlaneShuntingModeCodeMbox,&(psPSModeCodeF->PSModeCode));
            PPlaneShuntingModeCode = &( psPSModeCodeF->PSModeCode);
            ResponseCmd=PlaneShuntingCmdProcess(*PPlaneShuntingModeCode);                           //根据"平面调车信号模式码"建立灯显示及语音的数据结构
            enqueue( ResponseCmd);
        }
    }

    while (1)
    {
        ReturnCmd = dequeue();

        if (ReturnCmd == 0xff)
        {
            usleep(100*1000);
            continue;
        }


        char buffer[80]={0};

        StatusNUM++;
        getnStatus( buffer,ReturnCmd,StatusNUM);
        insertDebugData(buffer);


#if 0
        extern  int getDebugChang;

        if (getDebugChang != -1)
        {
            StatusNUM++;
            getnStatus( buffer,ReturnCmd,StatusNUM);
            endebugqueue(&endebugNUM,buffer);
            endebugNUM++;
        }
#endif

//add shiran 20140605
#if 1
        char debugbuf[100];

        memset(debugbuf,0,sizeof(debugbuf));
        sprintf(debugbuf," ReturnCmd %d Map27App1.CurrnRecvID %d ",ReturnCmd,Map27App1.CurrnRecvID);
        AddDebugLog(debugbuf);
#endif

        Map27link1.SetStatus (APP_IDLE);
        if (ReturnCmd!=99) //99代表无效应答命令
        {
            //   printf("ReturnCmd 2 %d\n",ReturnCmd);
            RecvMessDisplayProc( ReturnCmd,Map27App1.CurrnRecvID);
            //回复给常规车台调车应答码
        }
        usleep(1000*100);
    }
}

/*********************************************************************************************************
**                            Task6 任务6
**功能描述：灯显动作执行(定时执行)
********************************************************************************************************/



//  g_ID.ident = GroupID;
extern char LastCmd;
void  Task6(void *pdata)
{


    Map27_MobileID g_ID;
    g_ID.pfix = cRecvPfix;
    g_ID.ident = nRecvID;

    pdata = pdata;                                      /* 避免编译警告 */
    static unsigned char SampleTimeCount=0;
    static unsigned char CmdFaultStopCount=0;

    unsigned char PlaneShuntingModeCodeValue;
    unsigned char ResponseCmd;
    while (1)
    {

        StaOutProc();                                   //灯显动作执行
#if 0
        if (SampleTimeCount>=4)                               //100ms采集一次灯状态
        {
            SampleTimeCount=0;
            GetLampStatus();
        }
        SampleTimeCount++;

#endif

        if (FALSE==BootStrapStatus)     //此时的断链或链接是map27协议真正检测的结果
        {
            if (COMSTATE_NOLINK==Map27link1.gOffnetCommState)          //遇到断链，启动定时器CmdFaultStopCount。
            {                                               //CmdFaultStopCount的初始值为0的目的是使map27协议一旦确定断链后，这个任务能及时下发“命令故障停车”
                if (CmdFaultStopCount>=120)                 //一旦断链持续时间超过3s，报发命令故障停车。
                {
                    CmdFaultStopCount=0;                        //25ms*120=3s
                    //gOffnetCommStateLast=gOffnetCommState;
                    ResponseCmd=STOP_FAULT;

                    if ( (  LastCmd == STOP           ) ||
                            (  LastCmd == STOP_EMERGENCY ) ||
                            (  LastCmd == STOP_FAULT     )  )
                    {

                        //  printf("test stop readay\n");
                    }
                    else
                    {

                        enqueue(ResponseCmd);
#if 1

                        memset(debugtest,0,sizeof(debugtest));
                        sprintf(debugtest," Task6 StaOutProc %d ",ResponseCmd);
                        AddDebugLog(debugtest);
#endif
                    }
#if 0

                    ResponseCmd =     PlaneShuntingCmdProcess(PlaneShuntingModeCodeValue);   //根据"平面调车信号模式码"建立灯显示及语音的数据结构
                    if (ResponseCmd!=99) //99代表无效应答命令
                    {
                        Map27link1.SendStatus(g_ID,ResponseCmd);                                               //回复给常规车台调车应答码
                    }
#endif
                }
                else
                {
                    CmdFaultStopCount++;                    //定时器CmdFaultStopCount加1
                }
            }
            else  if (COMSTATE_OK==Map27link1.gOffnetCommState)   		//如果处于链接状态，
            {
                CmdFaultStopCount=0;                        //立刻复位定时器CmdFaultStopCount。即使上一次为断链状态，板卡也不可主动发“命令故障解锁”

            }
        }


        usleep(25*1000);                 //延时25ms
    }
}






/****************************************************************************
* 名称:         void LampControlPreparation(unsigned char es_tab_value)
* 输入参数:     unsigned char es_tab_value  从暂态执行表查得的数据
* 输出参数：    unsigned char
* 功能:         根据执行表查得的数据，给调车灯分配灯动作结构体
****************************************************************************/
unsigned char LampControlPreparation(unsigned char es_tab_value)
{
    unsigned char StaNotChgFlagTmp;
    switch (es_tab_value)
    {
    case 0:
        assignStLampCtrl(&LampCtrlStr[greenlamp],&StLampCtrlArg[LAMPON1]);              //绿常亮
        StaNotChgFlagTmp=0;
        break;
    case 1:
        AllLampOff();
        assignStLampCtrl(&LampCtrlStr[greenlamp],&StLampCtrlArg[LAMPON1]);              //绿常亮,其余灯灭
        StaNotChgFlagTmp=0;
        break;
    case 2:
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPON1]);             //黄常亮
        StaNotChgFlagTmp=0;
        break;
    case 3:
        AllLampOff();
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPON1]);             //黄常亮，其余灯灭
        StaNotChgFlagTmp=0;
        break;
    case 4:
        assignStLampCtrl(&LampCtrlStr[redlamp1],&StLampCtrlArg[LAMPON1]);               //红1常亮
        StaNotChgFlagTmp=0;
        break;
    case 5:
        AllLampOff();                                                                   //红1常亮，其余灯灭
        assignStLampCtrl(&LampCtrlStr[redlamp1],&StLampCtrlArg[LAMPON1]);
        StaNotChgFlagTmp=0;
        break;
    case 6:
        assignStLampCtrl(&LampCtrlStr[redlamp2],&StLampCtrlArg[LAMPON1]);               //红2常亮
        StaNotChgFlagTmp=0;
        break;
    case 7:
        AllLampOff();                                                                   //红2常亮，其余灯灭
        assignStLampCtrl(&LampCtrlStr[redlamp2],&StLampCtrlArg[LAMPON1]);
        StaNotChgFlagTmp=0;
        break;
    case 8:
        assignStLampCtrl(&LampCtrlStr[greenlamp],&StLampCtrlArg[LAMPFLASH2]);           //绿闪2次
        StaNotChgFlagTmp=0;
        break;
    case 9:
        AllLampOff();
        assignStLampCtrl(&LampCtrlStr[greenlamp],&StLampCtrlArg[LAMPFLASH2]);           //绿闪2次，其余灯灭
        StaNotChgFlagTmp=0;
        break;
    case 10:
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPFLASH5]);          //黄闪5次
        StaNotChgFlagTmp=0;
        break;
    case 11:
        AllLampOff();                                                                   //黄闪5次，其余灯灭
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPFLASH5]);
        StaNotChgFlagTmp=0;
        break;
    case 12:
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPFLASH3]);          //黄闪3次
        StaNotChgFlagTmp=0;
        break;
    case 13:
        AllLampOff();                                                                   //黄闪3次，其余灯灭
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPFLASH3]);
        StaNotChgFlagTmp=0;
        break;
    case 14:
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPFLASH2]);          //黄闪2次
        StaNotChgFlagTmp=0;
        break;
    case 15:
        AllLampOff();                                                                   //黄闪2次，其余灯灭
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPFLASH2]);
        StaNotChgFlagTmp=0;
        break;
    case 16:
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPFLASH1]);          //黄闪1次
        StaNotChgFlagTmp=0;
        break;
    case 17:
        AllLampOff();                                                                   //黄闪1次，其余灯灭
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPFLASH1]);
        StaNotChgFlagTmp=0;
        break;
    case 18:
        AllLampOff();                                                                   //红1、绿互闪3次，其余灯灭
        assignStLampCtrl(&LampCtrlStr[redlamp1],&StLampCtrlArg[LAMPFLASH3]);
        assignStLampCtrl(&LampCtrlStr[greenlamp],&StLampCtrlArg[LAMPFLASH3REVERSE]);
        StaNotChgFlagTmp=0;
        break;
    case 19:
        AllLampOff();                                                                   //红1、绿互闪3次，其余灯灭
        assignStLampCtrl(&LampCtrlStr[redlamp1],&StLampCtrlArg[LAMPFLASH3]);
        assignStLampCtrl(&LampCtrlStr[greenlamp],&StLampCtrlArg[LAMPFLASH3REVERSE]);
        StaNotChgFlagTmp=0;
        break;
    case 20:
        AllLampOff();                                                                   //黄、绿互闪3次，其余灯灭
        assignStLampCtrl(&LampCtrlStr[yellowlamp],&StLampCtrlArg[LAMPFLASH3]);
        assignStLampCtrl(&LampCtrlStr[greenlamp],&StLampCtrlArg[LAMPFLASH3REVERSE]);
        StaNotChgFlagTmp=0;
        break;
    case 21:
        assignStLampCtrl(&LampCtrlStr[redlamp1],&StLampCtrlArg[LAMPFLASHALWAYS]);       //红1闪
        StaNotChgFlagTmp=0;
        break;
    case 22:
        AllLampOff();                                                                   //红1闪，其余灯灭
        assignStLampCtrl(&LampCtrlStr[redlamp1],&StLampCtrlArg[LAMPFLASHALWAYS]);
        StaNotChgFlagTmp=0;
        break;
    case 23:                                                                            //无灯
        AllLampOff();
        StaNotChgFlagTmp=0;
        break;
    case 24:
        AllLampOff();                                                                   //红1、红2常亮，其余灯灭
        assignStLampCtrl(&LampCtrlStr[redlamp1],&StLampCtrlArg[LAMPON1]);
        assignStLampCtrl(&LampCtrlStr[redlamp2],&StLampCtrlArg[LAMPON1]);
        StaNotChgFlagTmp=0;
        break;
    case 25:
        AllLampOff();                                                                   //红1闪、红2常亮，其余灯灭
        assignStLampCtrl(&LampCtrlStr[redlamp1],&StLampCtrlArg[LAMPFLASHALWAYS]);
        assignStLampCtrl(&LampCtrlStr[redlamp2],&StLampCtrlArg[LAMPON1]);
        StaNotChgFlagTmp=0;
        break;
    case 26:                                                                            //?

        break;
    case 27:

    case 28:
        StaNotChgFlagTmp=1; //不改变当前状态
        break;
    case 29:
        assignStLampCtrl(&LampCtrlStr[redlamp1],&StLampCtrlArg[LAMPOFF1]);              //红1灯灭
        break;
    case 30:
        assignStLampCtrl(&LampCtrlStr[redlamp2],&StLampCtrlArg[LAMPOFF1]);              //红2灯灭
        break;
    case 31:
        StaNotChgFlagTmp=1;
        break;

    }

#if 1

    memset(debugtest,0,sizeof(debugtest));
    sprintf(debugtest," es_tab_value %d StaNotChgFlagTmp %d ",es_tab_value,StaNotChgFlagTmp);
    AddDebugLog(debugtest);
#endif
    return StaNotChgFlagTmp;
}

/****************************************************************************
* 名称:         void BuildTCtrlS(unsigned char PlaneShuntingCmd)
* 输入参数:     unsigned char PlaneShuntingCmd  调车命令码
* 输出参数：    unsigned char
* 功能:         建立暂态数据结构
****************************************************************************/
void BuildTCtrlS(unsigned char PlaneShuntingCmd)    //Build state's temporary data Structure
{
    unsigned char es_tab_value;
    Sta_Old_Tmp=st_tab[PlaneShuntingCmd][Sta_Old];          //查暂态转移表
    es_tab_value=es_tab[PlaneShuntingCmd][Sta_Old];         //查暂态执行表
    StaNotChgFlag=LampControlPreparation(es_tab_value);     //根据暂态执行表的值建立灯控数据结构

#if 1

    memset(debugtest,0,sizeof(debugtest));
    sprintf(debugtest,"暂态 BuildTCtrlS:Sta_Old_Tmp %d es_tab_value %d StaNotChgFlag %d Sta_Old %d  ",Sta_Old_Tmp,es_tab_value,StaNotChgFlag,Sta_Old);
    AddDebugLog(debugtest);
#endif
}

/****************************************************************************
* 名称：       void BuildVCtrlS(unsigned char PlaneShuntingCmd)
* 输入参数:    unsigned char PlaneShuntingCm 调车命令码
* 输出参数：   unsigned char 语音结构体的序号
* 功能:        完成调车命令码到语音结构体的序号的转换
****************************************************************************/
void BuildVCtrlS(unsigned char PlaneShuntingCmd)                   //Build voice's data Structure
{
    unsigned char vt_tab_value;
    vt_tab_value=vt_tab[PlaneShuntingCmd][Sta_Old];                 //查语音输出表
    if ( ( (vt_tab_value>=17)&(vt_tab_value<=27) ) | (vt_tab_value>=30)|(vt_tab_value==29) )    //如果查vt_tab得到的值VtTabValue在17~27或30~31之间，维持原声音
    {																							//vt_tab_value==29,无声
        ;
    }
    else
    {
        VoicePlayFlag=TRUE;
        PlayVoiceNum=vt_tab_value;
        //  printf("BuildVCtrlS\n");
    }
}

/****************************************************************************
* 名称：       void BuildFCtrlS(unsigned char PlaneShuntingCmd)
* 输入参数:    unsigned char PlaneShuntingCmd 调车命令码
* 输出参数：   void
* 功能:        建立稳态数据结构
*              根据调车命令码，通过查表得出 Sta_Steady 、Exu_Steady这两个数据
****************************************************************************/
void BuildFCtrlS(unsigned char PlaneShuntingCmd)    //Build state's final data Structure
{
    Sta_Steady=ft_tab[PlaneShuntingCmd][Sta_Old];   //查稳态转移表
    Exu_Steady=ef_tab[PlaneShuntingCmd][Sta_Old];   //查稳态执行表

#if 1

    memset(debugtest,0,sizeof(debugtest));
    sprintf(debugtest,"暂态 Sta_Steady %d Exu_Steady %d Sta_Old %d",Sta_Steady,Exu_Steady,Sta_Old);
    AddDebugLog(debugtest);
#endif
}

/****************************************************************************
* 名称：       unsigned char GetRPTabValue(unsigned char PlaneShuntingCmd)
* 输入参数:    unsigned char PlaneShuntingCmd 调车命令码
* 输出参数：   unsigned char
* 功能:        根据调车命令码，通过查表得出应答码
****************************************************************************/
unsigned char GetRPTabValue(unsigned char PlaneShuntingCmd)
{
    unsigned char ResponseCmd;
    ResponseCmd=rp_tab[PlaneShuntingCmd][Sta_Old];
    return ResponseCmd;
}

/****************************************************************************
* 名称：       unsigned char PlaneShuntingCmdProcess(unsigned PlaneShuntingModeCode)
* 输入参数:    unsigned char PlaneShuntingModeCode 平面调车信号模式码
* 输出参数：   unsigned char 平面调车应答码
* 功能:        平面调车命令处理
****************************************************************************/
unsigned char PlaneShuntingCmdProcess(unsigned char PlaneShuntingModeCode)
{
    static unsigned char EmgStopRec=((psPSModeCodeF->PSModeCode)>>5)&0x03;  //“紧急停车”调车命令码发送者
    unsigned char PlaneShuntingCmd;             	//调车命令码
    unsigned char BuildStrFlag=1;
    unsigned char ResponseCmd;
    unsigned char ModeCodeRec;						//此变量专门用来记录“紧急停车”平面调车信号

    un_PlaneShuntingModeCode.PlaneShuntingModeCode=PlaneShuntingModeCode;	//将平面调车信号模式码的值赋给一个联合体
    PlaneShuntingCmd=un_PlaneShuntingModeCode.bits.PlaneShuntingCmd;		//从联合体中取得调车命令码

    if (PlaneShuntingCmd==STOP_EMERGENCY)                   //如果是紧急停车命令，
    {                                                       //记录命令的发送者(01表示linker1或10表示linker2)
        EmgStopRec|=un_PlaneShuntingModeCode.bits.CmdSender;

        ModeCodeRec=((psPSModeCodeF->PSModeCode) >>5) & 0x03;
        if ( ModeCodeRec!= EmgStopRec )									//如果flash中记录的“紧急停车”相关信息与需要记录的信息一致，就无需重写flash。
        {																//减少flash的烧写次数
            ModeCodeRec=(EmgStopRec<<5)|STOP_EMERGENCY;
            PSModeCodeRec(ModeCodeRec);
        }
    }
    else if (PlaneShuntingCmd==CANCEL_STOP_EMERGENCY)       //如果是拆除紧急停车命令，
    {                                                       //判断命令的发送者是否与紧急停车命令的发送者相同

        EmgStopRec=EmgStopRec^(EmgStopRec&(un_PlaneShuntingModeCode.bits.CmdSender));  //必须由下达紧急停车命令者自己进行拆除

        if (EmgStopRec!=0)		//此拆除紧急停车命令无效，
        {
            BuildStrFlag=0;		//无需建立建立灯显和语音的数据结构
        }

        ModeCodeRec=((psPSModeCodeF->PSModeCode) >>5) & 0x03;
        if ( ModeCodeRec!= EmgStopRec )									//如果flash中记录的“紧急停车”相关信息与需要记录的信息一致，就无需重写flash。
        {																//减少flash的烧写次数
            ModeCodeRec=(EmgStopRec<<5)|STOP_EMERGENCY;
            PSModeCodeRec(ModeCodeRec);
        }
    }


#if 1

    memset(debugtest,0,sizeof(debugtest));
    sprintf(debugtest," EmgStopRec %d ",EmgStopRec);
    AddDebugLog(debugtest);
#endif

    if (BuildStrFlag==1)                        //建立灯显和语音的数据结构
    {
        BuildTCtrlS(PlaneShuntingCmd);              //建立暂态数据结构
        BuildVCtrlS(PlaneShuntingCmd);              //完成调车命令码到语音结构体的序号的转换
        BuildFCtrlS(PlaneShuntingCmd);              //建立稳态数据结构
    }
    ResponseCmd=GetRPTabValue(PlaneShuntingCmd);        //得到调车应答码
    if (StaNotChgFlag!=TRUE)                            //判断是否将查暂态转移表得到的值设为当前状态
    {
        Sta_Old=Sta_Old_Tmp;
    }

    return ResponseCmd;
}

/*********************灯显动作及语音的执行部分*******************************/


/****************************************************************************
* 名称：        unsigned char Lamp_Out(unsigned char lamptype)
* 输入参数:     unsigned char lamptype 灯类型(绿 黄 红1 红2)
* 输出参数：    unsigned char 灯显动作是否执行完毕
* 功能:         灯显动作执行
****************************************************************************/
#if 1
int LAMPPORTCLR =0 ;
int LAMPPORTSET = 0;
int LAMPSTATUSREG = 0;


#define LAMPON(lamp)        SETBIT(LAMPPORTCLR,(lamp))
#define LAMPOFF(lamp)       SETBIT(LAMPPORTSET,(lamp))
#define LAMPSTATUS(lamp)    GETBIT(LAMPSTATUSREG,(lamp))

#endif
extern DWORD m_GLampBackGround,m_YLampBackGround,m_sysBackGround;
extern DWORD m_RLamp1BackGround,m_RLamp2BackGround;
unsigned char Lamp_Out(unsigned char lamptype)
{
    if (LampCtrlStr[lamptype].CycNumb==0)
    {
        return TRUE;
    }

    LampCtrlStr[lamptype].CtrlTimer++;                                          //灯计数器加1

    if (LampCtrlStr[lamptype].CtrlTimer==LampCtrlStr[lamptype].OnTime)
    {
        LAMPON(lamptypeToPin[lamptype]);		//点灯
        //  printf("lampon 点灯 %d\n",lamptype);

    }
    else if (LampCtrlStr[lamptype].CtrlTimer==LampCtrlStr[lamptype].OffTimer)
    {
        LAMPOFF(lamptypeToPin[lamptype]);
        //  printf("lampon 灭灯 %d\n",lamptype);
        //  printf("lampon 灭灯\n");//灭灯
    }
    if (LampCtrlStr[lamptype].CtrlTimer>=CTRLPERD)
    {
        LampCtrlStr[lamptype].CtrlTimer=0;                                      //灯计数器的值达到控制周期数，置0。一个周期执行完毕。

        if (LampCtrlStr[lamptype].CycNumb!=0xff)        //如果CycNumb!=0xff，按CycNumb中定义的次数执行
        {
            LampCtrlStr[lamptype].CycNumb--;
            if (LampCtrlStr[lamptype].CycNumb==0)
            {
                return TRUE;
            }
        }
    }

    if (LampCtrlStr[lamptype].CycNumb==0xff)            //如果CycNumb==0xff，循环执行
    {
        return TRUE;
    }

    return FALSE;
}

/****************************************************************************
* 名称：          void StaOutProc(void)
* 输入参数:       void
* 输出参数：      void
* 功能:           灯显动作，在主程序中被定时循环调用
****************************************************************************/
void StaOutProc(void)
{
    unsigned char i;
    unsigned char LampOutOver[4];
    unsigned char LampOutAllOver=TRUE;

    for (i=greenlamp;i<=redlamp2;i++)   //执行灯显动作
    {
        LampOutOver[i]=Lamp_Out(i);
        if (LampOutOver[i]==FALSE)
        {
            LampOutAllOver=FALSE;
        }
    }
    if (LampOutAllOver==TRUE)          //暂态或稳态执行完毕，根据稳态执行表的值建立灯控数据结构
    {
        if (LampControlPreparation(Exu_Steady)==FALSE)  //判断是否将稳态转移表中的值设为当前状态
        {
            Sta_Old=Sta_Steady;
        }
    }
}

/****************************************************************************
* 名称：           void GetLampStatus(void)
* 输入参数:        无
* 输出参数：       无
* 功能:            读取灯状态
****************************************************************************/

//extern int gTrunkCommState,gOffnetCommState,gMonitorCommState;
void GetLampStatus(void)
{
    unsigned char LampStatusTemp=0;
    unsigned char i;
    for (i=greenlamp;i<=redlamp2;i++)
    {
        LampStatusTemp|=(LAMPSTATUS(lamptypeToPin[i]))<<i;
    }
    LampStatusTemp^=0x0f;   //取反低4位，1表示灯亮，0表示灯灭(D0~D3分别对应绿、黄、红1、红2)


#if 0

    if (COMSTATE_NOLINK==gTrunkCommState)           //如果集群车台处于断链状态，将LampStatusTemp的D4为清0 2009.12.4 huangchao
    {
        LampStatusTemp&=0xef;
    }
    else if (COMSTATE_OK==gTrunkCommState)          //如果集群车台处于链接状态，将LampStatusTemp的D4为置1
    {
        LampStatusTemp|=0x10;
    }
#endif

    if (COMSTATE_NOLINK==Map27link1.gOffnetCommState)          //如果常规车台处于断链状态，将LampStatusTemp的D5为清0
    {
        LampStatusTemp&=0xdf;
    }
    else if (COMSTATE_OK==Map27link1.gOffnetCommState)         //如果常规车台处于链接状态，将LampStatusTemp的D5为置1
    {
        LampStatusTemp|=0x20;
    }

    //  CommFlagProc();                                 //集群、常规通讯指示
    //  PrgFlagProc();                                  //程序指示

    //  OS_ENTER_CRITICAL();

    LampStatusBuf[LampStatusTail]=LampStatusTemp;
    LampStatusTail++;
    if (LampStatusTail>=LAMPSTATUSBUFLEN)
    {
        LampStatusTail=0;
    }
    // OS_EXIT_CRITICAL() ;
}

/****************************************************************************
* 名称：       void PSModeCodeRec(unsigned char PSModeCode)
* 输入参数:    PSModeCode 调车码
* 输出参数：   无
* 功能:        将调车码写入flash
****************************************************************************/
void PSModeCodeRec(unsigned char PSModeCode)
{
    sPSModeCodeR.PSModeCodeValid=TRUE;				//表明此flash记录过调车数据，不是未被烧写过的flash。
    sPSModeCodeR.PSModeCode=PSModeCode;

    if (psPSModeCodeF->FlashWriteTime==0xffffffff)	//记录flash被烧写的次数
    {
        sPSModeCodeR.FlashWriteTime=1;
    }
    else
    {
        sPSModeCodeR.FlashWriteTime=(psPSModeCodeF->FlashWriteTime)+1;
    }

    //delete shiran
    // WrFlash(MODECODESECTOR,MODECODESECTOR,ModeCodeLocationF,ModeCodeLocationR,256);
}








int main(int argc, char **argv) {

    return 0;
}
